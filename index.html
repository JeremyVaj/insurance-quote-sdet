<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Unified Quote & Coverage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: #111827;
      display: flex;
      justify-content: center;
      align-items: center;
      background:
        radial-gradient(circle at 20% 20%, rgba(102,126,234,0.45), transparent 60%),
        radial-gradient(circle at 80% 30%, rgba(118,75,162,0.45), transparent 60%),
        radial-gradient(circle at 50% 80%, rgba(102,126,234,0.35), transparent 70%),
        linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      background-size: cover;
      overflow: hidden;
      min-height: 100vh;
    }
    .card {
      width: 100%;
      max-width: 860px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      padding: 32px 36px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(12px);
      position: relative;
      z-index: 2;
    }
    h1 { margin: 0 0 8px; font-size: 26px; font-weight: 800; color:#1e1e1e; }
    .sub { color:#6b7280; margin-bottom: 20px; font-size:14px; }
    fieldset { border: 0; padding: 0; margin: 0 0 18px; }
    label { display:block; font-weight:600; margin:10px 0 6px; color:#374151; }
    select, input[type="number"] {
      width: 100%; padding: 12px 14px; border:1.8px solid #e5e7eb; border-radius:10px;
      font-size: 16px; background:#fff; transition: border-color .2s, box-shadow .2s;
    }
    select:focus, input[type="number"]:focus {
      outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.15);
    }
    .notice {
      background:#eef2ff; border-left:4px solid #4f46e5; padding:12px 14px;
      border-radius:10px; color:#1e3a8a; font-size:14px;
    }
    .warn { background:#fff7ed; border-left-color:#f59e0b; color:#7c2d12; }
    .coverage { display:none; margin-top: 10px; }
    .coverage.visible { display:block; }
    .coverage-option {
      display:flex; gap:10px; align-items:center;
      border:1.5px solid #e5e7eb; border-radius:10px; padding:12px 14px; margin:10px 0;
      cursor:pointer; transition: all .2s;
    }
    .coverage-option:hover { border-color:#667eea; background:#f7f9ff; }
    .coverage-option input { margin:0; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 760px){ .row { grid-template-columns: 1fr; } }
    .btn {
      display:block; width:100%; padding:14px;
      font-weight:700; color:#fff; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border:0; border-radius:10px; cursor:pointer; transition:transform .2s, opacity .2s;
    }
    .btn:hover { transform:translateY(-2px); }
    .btn:disabled { opacity:.6; cursor:not-allowed; transform:none; }
    .result, .error, .loading {
      display:none; margin-top: 16px; border-radius:10px; padding:12px 14px;
    }
    .result.show { display:block; background:#ecfeff; border-left:4px solid #06b6d4; }
    .error.show  { display:block; background:#fef2f2; border-left:4px solid #ef4444; color:#991b1b; }
    .loading.show { display:block; background:#eef2ff; border-left:4px solid #4f46e5; color:#312e81; }
    .premium { font-size:28px; font-weight:800; color:#0ea5e9; margin:4px 0; }
    .muted { font-size:12px; color:#6b7280; }
  </style>
</head>
<body>
  <main class="card">
    <h1 data-testid="page-title">Insurance Quote & Coverage</h1>
    <div class="sub" data-testid="page-subtitle">Submit enabled only for V2 states with a coverage selected</div>

    <form id="quoteForm" data-testid="quote-form" novalidate>
      <!-- State -->
      <fieldset>
        <label for="state" data-testid="state-label">Customer State</label>
        <select id="state" data-testid="state-select" required>
          <option value="">-- Select State --</option>
          <option value="WI">Wisconsin (WI)</option>
          <option value="OH">Ohio (OH)</option>
          <option value="IL">Illinois (IL)</option>
          <option value="NV">Nevada (NV)</option>
          <option value="TX">Texas (TX)</option>
          <option value="NY">New York (NY)</option>
          <option value="CA">California (CA)</option>
        </select>
        <div id="v1Notice" class="notice warn" style="display:none" data-testid="v1-message">
          New coverage options are not available in your state.
        </div>
      </fieldset>

      <!-- Coverage (only for V2) -->
      <fieldset id="coverageFieldset" class="coverage" data-testid="coverage-container" aria-hidden="true">
        <div class="notice" style="margin-bottom:10px">New coverage options are available in your state.</div>

        <div class="coverage-option" data-testid="coverage-none">
          <input type="radio" id="cov-none" name="coverage" value="none" checked />
          <label for="cov-none"><strong>None</strong> — No additional coverage</label>
        </div>

        <div class="coverage-option" data-testid="coverage-silver">
          <input type="radio" id="cov-silver" name="coverage" value="silver" />
          <label for="cov-silver"><strong>Silver</strong> — Basic coverage package</label>
        </div>

        <div class="coverage-option" data-testid="coverage-gold">
          <input type="radio" id="cov-gold" name="coverage" value="gold" />
          <label for="cov-gold"><strong>Gold</strong> — Enhanced coverage package</label>
        </div>

        <div class="coverage-option" data-testid="coverage-platinum">
          <input type="radio" id="cov-platinum" name="coverage" value="platinum" />
          <label for="cov-platinum"><strong>Platinum</strong> — Premium coverage package</label>
        </div>
      </fieldset>

      <!-- Business & Revenue -->
      <fieldset class="row">
        <div>
          <label for="business" data-testid="business-label">Business Type</label>
          <select id="business" data-testid="business-select" required>
            <option value="">-- Select Business Type --</option>
            <option value="retail">Retail</option>
            <option value="restaurant">Restaurant</option>
            <option value="professional">Professional Services</option>
            <option value="manufacturing">Manufacturing</option>
          </select>
        </div>

        <div>
          <label for="revenue" data-testid="revenue-label">Annual Revenue ($)</label>
          <input type="number" id="revenue" data-testid="revenue-input" inputmode="numeric" min="0" placeholder="50000" required />
        </div>
      </fieldset>

      <!-- Submit -->
      <button type="submit" class="btn" id="submitButton" data-testid="submit-button" disabled>Get Quote</button>

      <!-- Feedback -->
      <div class="loading" id="loading" data-testid="loading-indicator">Calculating your quote…</div>

      <div class="result" id="quoteResult" data-testid="quote-result-container">
        <div style="font-weight:700; margin-bottom:4px" data-testid="quote-result-title">Your Insurance Quote</div>
        <div class="premium" data-testid="premium-amount">$0.00</div>
        <div class="muted" data-testid="premium-label">Annual Premium</div>
        <div class="muted" data-testid="quote-id-display">Quote ID:</div>
        <div class="muted" data-testid="quote-timestamp"></div>
      </div>

      <div class="error" id="error" data-testid="error-container">
        <strong data-testid="error-title">Error:</strong> <span id="errorText" data-testid="error-message"></span>
      </div>
    </form>
  </main>

  <script>
    const V2_STATES = ['WI', 'OH', 'IL', 'NV']; // coverage available
    const V1_STATES = ['TX', 'NY', 'CA'];       // coverage not available
    const API_URL   = 'https://rating-api.jeremy-vajko.workers.dev/';

    const form        = document.getElementById('quoteForm');
    const stateSel    = document.getElementById('state');
    const businessSel = document.getElementById('business');
    const revenueInp  = document.getElementById('revenue');
    const submitBtn   = document.getElementById('submitButton');

    const coverageFs  = document.getElementById('coverageFieldset');
    const v1Notice    = document.getElementById('v1Notice');

    const loadingEl   = document.getElementById('loading');
    const resultEl    = document.getElementById('quoteResult');
    const premiumEl   = document.querySelector('[data-testid="premium-amount"]');
    const quoteIdEl   = document.querySelector('[data-testid="quote-id-display"]');
    const tsEl        = document.querySelector('[data-testid="quote-timestamp"]');
    const errorEl     = document.getElementById('error');
    const errorTextEl = document.getElementById('errorText');

    function selectedCoverageValue() {
      const checked = document.querySelector('input[name="coverage"]:checked');
      return checked ? checked.value : null;
    }

    function updateCoverageVisibility() {
      const st = stateSel.value;

      // Always default to "None" when entering a V2 state
      const none = document.getElementById('cov-none');
      if (V2_STATES.includes(st) && none) {
        none.checked = true;
      }

      if (V2_STATES.includes(st)) {
        coverageFs.classList.add('visible');
        coverageFs.setAttribute('aria-hidden', 'false');
        v1Notice.style.display = 'none';
      } else if (V1_STATES.includes(st)) {
        coverageFs.classList.remove('visible');
        coverageFs.setAttribute('aria-hidden', 'true');
        v1Notice.style.display = 'block';
      } else {
        // Unknown/empty -> hide both
        coverageFs.classList.remove('visible');
        coverageFs.setAttribute('aria-hidden', 'true');
        v1Notice.style.display = 'none';
      }

      updateSubmitEnabled();
    }

    function updateSubmitEnabled() {
      const st         = stateSel.value;
      const hasBusiness= businessSel.value !== '';
      const hasRevenue = revenueInp.value !== '' && Number(revenueInp.value) >= 0;

      // New rule: only enable submit for V2 states *and* when a coverage is selected
      const isV2       = V2_STATES.includes(st);
      const hasCoverage= !!selectedCoverageValue(); // "None" counts in V2

      submitBtn.disabled = !(isV2 && hasCoverage && hasBusiness && hasRevenue);
    }

    stateSel.addEventListener('change', updateCoverageVisibility);
    businessSel.addEventListener('change', updateSubmitEnabled);
    revenueInp.addEventListener('input', updateSubmitEnabled);
    document.querySelectorAll('input[name="coverage"]').forEach(r =>
      r.addEventListener('change', updateSubmitEnabled)
    );

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      resultEl.classList.remove('show');
      errorEl.classList.remove('show');
      loadingEl.classList.add('show');

      const payload = {
        revenue: Number(revenueInp.value),
        state: stateSel.value,
        business: businessSel.value
        // Coverage is Story 2 UI only; not sent to Story 1 API
      };

      try {
        const resp = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        loadingEl.classList.remove('show');

        if (resp.ok) {
          premiumEl.textContent = `$${Number(data.premium).toFixed(2)}`;
          quoteIdEl.textContent = `Quote ID: ${data.quoteId || ''}`;
          tsEl.textContent = data.calculatedAt ? `Generated: ${new Date(data.calculatedAt).toLocaleString()}` : '';
          resultEl.classList.add('show');
        } else {
          errorTextEl.textContent = data.message || data.error || 'Request failed';
          errorEl.classList.add('show');
        }
      } catch (err) {
        loadingEl.classList.remove('show');
        errorTextEl.textContent = 'Network error';
        errorEl.classList.add('show');
      }
    });

    // Init
    updateCoverageVisibility();
    updateSubmitEnabled();
  </script>
</body>
</html>
